<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="Internet radio player with support for multiple stations.">
    <meta name="keywords" content="Radio, Internet Radio, Zeno Fm, Gaming, Gaming music, Radio Gaming">
    <meta name="author" content="K5 Studio">
    <meta property="og:image" content="https://radio-gaming.stream/Images/Logos/Radio-Gaming-Logo.webp">
    <meta name="twitter:image" content="https://radio-gaming.stream/Images/Radio-Gaming-Dark-background.webp">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio GAMING</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="radio.css">

</head>

<body>
    <!-- Loading screen -->
    <div class="loading-screen">
        <div class="lds-ripple">
            <div></div>
            <div></div>
        </div>
    </div>
    <!--<div id="notificationPopup"></div> -->
    <div id="notificationContainer"></div>

    <header>
        <nav>
            <div class="header-content">
                <a href="../.." class="logo">
                    <img src="https://radio-gaming.stream/Images/Logos/Radio-Gaming-Logo.webp" alt="Logo">
                    <span>Radio GAMING</span>
                </a>
                <ul>
                    <li><a href="javascript:void(0)" onclick="switchSection('home')" class="active-nav-link"><i
                                class="fas fa-home"></i>
                            <span>Home</span></a></li>
                    <li><a href="javascript:void(0)" onclick="switchSection('download')"><i class="fas fa-download"></i>
                            <span>Download</span></a></li>
                    <li><a href="javascript:void(0)" onclick="switchSection('info')"><i class="fas fa-info-circle"></i>
                            <span>Info</span></a></li>
                </ul>
                <div class="header-right">
                    <div class="status-badge"><span class="dot"></span> Online</div>
                </div>
            </div>
        </nav>
    </header>
    <main>
        <section id="home-section" class="page-section active">
            <!--<div class="section-title">Now Playing</div>-->
            <h1 id="StationNameInh1">Radio GAMING</h1>

            <!--<div class="section-title">Select Station</div>-->
            <div class="station-selector">
                <div class="station-photo active"
                    onclick="changeStation('https://stream.zeno.fm/es4ngpu7ud6tv', 'Radio GAMING', 'https://api.zeno.fm/mounts/metadata/subscribe/es4ngpu7ud6tv')">
                    <img src="https://radio-gaming.stream/Images/Logos/Radio-Gaming-Logo.webp" alt="Radio GAMING">
                    <div class="tooltip">
                        <img src="https://radio-gaming.stream/Images/Logos/Radio%20Gaming%20Logo%20with%20miodzix%20planet.png"
                            alt="Album Cover" class="tooltip-cover" />
                        <div class="tooltip-track">Loading...</div>
                        <div class="tooltip-Online-Users">Loading Live Listeners Count...</div>
                    </div>
                </div>

                <div class="station-photo"
                    onclick="changeStation('https://stream.zeno.fm/pfg9eajshnjtv', 'Radio GAMING DARK', 'https://api.zeno.fm/mounts/metadata/subscribe/pfg9eajshnjtv')">
                    <img src="https://radio-gaming.stream/Images/Logos/Radio-Gaming-dark-logo.webp"
                        alt="Radio GAMING DARK">
                    <div class="tooltip">
                        <img src="https://radio-gaming.stream/Images/Logos/Radio%20Gaming%20Logo%20with%20miodzix%20planet.png"
                            alt="Album Cover" class="tooltip-cover" />
                        <div class="tooltip-track">Loading...</div>
                        <div class="tooltip-Online-Users">Loading Live Listeners Count...</div>
                    </div>
                </div>
                <div class="station-photo"
                    onclick="changeStation('https://stream.zeno.fm/5nhy0myl4jpuv', 'Radio GAMING MARON FM', 'https://api.zeno.fm/mounts/metadata/subscribe/5nhy0myl4jpuv')">
                    <img src="https://radio-gaming.stream/Images/Logos/Radio-Gaming-Maron-fm-logo.webp"
                        alt="Radio GAMING MARON FM">
                    <div class="tooltip">
                        <img src="https://radio-gaming.stream/Images/Logos/Radio%20Gaming%20Logo%20with%20miodzix%20planet.png"
                            alt="Album Cover" class="tooltip-cover" />
                        <div class="tooltip-track">Loading...</div>
                        <div class="tooltip-Online-Users">Loading Live Listeners Count...</div>
                    </div>
                </div>
            </div>

            <div class="audio-player" id="radioPlayer">
                <audio id="audioPlayer" controls>
                    <source src="https://stream.zeno.fm/es4ngpu7ud6tv" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
                <div class="album-cover-and-title">
                    <img id="albumCover"
                        src="https://radio-gaming.stream/Images/Logos/Radio%20Gaming%20Logo%20with%20miodzix%20planet.png"
                        alt="Album Cover" class="album-cover">
                    <div id="streamTitle"></div>
                </div>
                <div class="player-controls">
                    <i id="playPauseIcon" class="fas fa-play" onclick="playPause()"></i>
                    <div id="timeDisplay">
                        <span id="currentTime">00:00</span> / <span id="liveIndicator">ðŸŸ£LIVE</span>
                    </div>
                    <div class="volume-control">
                        <i id="volume-down" class="fas fa-volume-down volume-icon"></i>
                        <input type="range" class="volume-slider" min="0" max="1" step="0.1" value="0.1"
                            onchange="changeVolume(this.value)">
                        <i id="volume-up" class="fas fa-volume-up volume-icon"></i>
                    </div>
                </div>
            </div>
        </section>

        <section id="info-section" class="page-section">
            <div class="info-card">
                <h1>Welcome to Radio GAMING!</h1>
                <p>Are you ready to immerse yourself in the ultimate music experience? Whether you're a casual gamer, a
                    competitive esports enthusiast, or simply someone who loves great music, Radio GAMING has something
                    for everyone.</p>
                <p><strong>Radio GAMING - Powering Your Gaming Experience.</strong></p>

                <div class="cta-section">
                    <a href="https://github.com/kubadoPL/Gaming-Radio/tree/main" target="_blank" class="btn">
                        <i class="fab fa-github"></i> View Documentation
                    </a>
                    <a href="https://k5studio.dev/" target="_blank" class="btn">
                        <i class="fas fa-project-diagram"></i> Other Projects
                    </a>
                </div>
            </div>
        </section>

        <section id="download-section" class="page-section">
            <div class="hero-section">
                <h1>Get Radio GAMING</h1>
                <p class="subtitle">Experience the ultimate gaming radio on your desktop. Stay tuned while you play with
                    our dedicated Windows application.</p>
            </div>

            <div class="download-grid">
                <div class="download-card">
                    <i class="fab fa-windows"></i>
                    <h3>Desktop Launcher</h3>
                    <p>Installer for Windows 10/11.<br>Includes automatic updates.</p>
                    <a href="https://github.com/kubadoPL/Gaming-Radio/raw/main/DesktopAPP/Radio%20Gaming%20Desktop%20Launcher%20Installer.exe"
                        target="_blank" class="btn">
                        <i class="fas fa-download"></i> Download Launcher (Auto updates)
                    </a>
                </div>

                <div class="download-card">
                    <i class="fas fa-file-exe"></i>
                    <h3>Standalone EXE</h3>
                    <p>Portable version for Windows.<br>No installation required.</p>
                    <a href="https://github.com/kubadoPL/Gaming-Radio/raw/main/DesktopAPP/Radio%20Gaming%20Desktop.exe"
                        target="_blank" class="btn">
                        <i class="fas fa-download"></i> Download Standalone EXE
                    </a>
                </div>
            </div>
        </section>
    </main>
    <script>
        function switchSection(sectionId) {
            // Remove active class from all sections
            const sections = document.querySelectorAll('.page-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });

            // Show target section
            const targetSection = document.getElementById(sectionId + '-section');
            if (targetSection) {
                targetSection.classList.add('active');
            }

            // Update nav links active state
            const navLinks = document.querySelectorAll('nav ul li a');
            navLinks.forEach(link => {
                link.classList.remove('active-nav-link');
                if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(`'${sectionId}'`)) {
                    link.classList.add('active-nav-link');
                }
            });

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Update title badge logic (optional)
            if (sectionId === 'info') {
                showNotification("Viewing Information");
            } else if (sectionId === 'download') {
                showNotification("Get the Desktop App!");
            }
        }

        var audio = document.getElementById('audioPlayer');
        var streamTitleElement = document.getElementById('streamTitle');
        var playPauseIcon = document.getElementById('playPauseIcon');
        var stationName = document.querySelector('h1');
        var eventSource = new EventSource('https://api.zeno.fm/mounts/metadata/subscribe/es4ngpu7ud6tv');
        var currentEventSource = eventSource;
        let globalCurrentColor = "#7300ff"; // Default color for the loading screen and scrollbar
        let fetching = false; // Flag to prevent multiple fetches
        let cooldown = false;
        let IsChangingStation = false; // Flag to prevent multiple station changes
        // Show loading screen
        document.querySelector('.loading-screen').style.backgroundColor = "#7300ff";
        document.querySelector('.loading-screen').style.display = 'flex';

        document.documentElement.style.setProperty('--scrollbar-thumb-color', '#7300ff');

        // Declare notificationTimeout outside of the function to maintain its scope
        var notificationTimeout;



        async function getSpotifyAccessToken() {
            const now = Date.now();

            // Try to read token and expiration from localStorage
            let cachedToken = localStorage.getItem('RadioGaming-spotifyAccessToken');
            let tokenExpiresAt = parseInt(localStorage.getItem('RadioGaming-spotifyTokenExpiresAt'), 10) || 0;

            if (cachedToken && now < tokenExpiresAt) {
                const msLeft = tokenExpiresAt - now;
                const secondsLeft = Math.floor(msLeft / 1000);
                const minutes = Math.floor(secondsLeft / 60);
                const seconds = secondsLeft % 60;
                const expiryDate = new Date(tokenExpiresAt).toLocaleString();

                console.log(`Using cached Spotify access token. Expires in ${minutes}m ${seconds}s (at ${expiryDate}).`);

                if (document.querySelector('.loading-screen').style.display != 'none') {
                    setTimeout(function () {

                        if (document.querySelector('.loading-screen').style.display != 'none') {
                            setTimeout(function () {
                                if (IsChangingStation == false) {
                                    if (document.querySelector('.loading-screen').style.display != 'none') {



                                        document.querySelector('.loading-screen').style.display = 'none';
                                        console.log('Album Covers token from CACHE. Hiding loading screen!');
                                    }
                                }
                            }, 2000); // 1000 milliseconds = 1 second
                        }
                    }, 1000); // 1000 milliseconds = 1 second
                }
                //showNotification(`Using cached Album Covers token. Expires in ${minutes}m ${seconds}s.`);
                return cachedToken;
            }
            if (fetching == true) {
                console.log('Already fetching a new Spotify access token. Please wait...');
                showNotification('Fetching Album Covers token...');
                return cachedToken; // Return the cached token while fetching
            }
            fetching = true; // Set the flag to true to prevent multiple fetches
            console.log('Fetching new Spotify access token...');

            const tokenUrl = 'https://bot-launcher-discord-017f7d5f49d9.herokuapp.com/K5ApiManager/spotify/token';
            showNotification('Fetching Album Covers token...');
            const response = await fetch(tokenUrl, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
            });

            const data = await response.json();

            if (response.ok) {
                cachedToken = data.access_token;
                const expiresIn = data.expires_in || 3600;
                const createdAt = new Date(data.created_at).getTime();
                tokenExpiresAt = createdAt + expiresIn * 1000 - 60000; // Subtract 1 minute for safety margin

                // Save token and expiration to localStorage
                localStorage.setItem('RadioGaming-spotifyAccessToken', cachedToken);
                localStorage.setItem('RadioGaming-spotifyTokenExpiresAt', tokenExpiresAt.toString());

                const now = Date.now();
                const msLeft = tokenExpiresAt - now;
                const secondsLeft = Math.max(0, Math.floor(msLeft / 1000)); // avoid negative
                const minutesLeft = Math.floor(secondsLeft / 60);
                const secondsRemaining = secondsLeft % 60;
                const timeStr = minutesLeft > 0
                    ? `${minutesLeft}m ${secondsRemaining}s`
                    : `${secondsRemaining}s`;

                const expiryDate = new Date(tokenExpiresAt).toLocaleString();

                console.log(`New Spotify token fetched. Valid for ${timeStr} (expires at ${expiryDate}).`);



                fetching = false; // Reset the flag after fetching
                if (document.querySelector('.loading-screen').style.display != 'none') {
                    setTimeout(function () {

                        if (document.querySelector('.loading-screen').style.display != 'none') {
                            setTimeout(function () {
                                if (IsChangingStation == false) {
                                    if (document.querySelector('.loading-screen').style.display != 'none') {


                                        document.querySelector('.loading-screen').style.display = 'none';
                                        console.log('Album Covers token fetched successfully. Hiding loading screen!');
                                    }
                                }
                            }, 2000); // 1000 milliseconds = 1 second
                        }
                    }, 1000); // 1000 milliseconds = 1 second
                }
                showNotification('Album Covers token fetched successfully!');
                return cachedToken;
            } else {
                fetching = false; // Reset the flag after fetching
                if (document.querySelector('.loading-screen').style.display != 'none') {
                    setTimeout(function () {

                        if (document.querySelector('.loading-screen').style.display != 'none') {
                            setTimeout(function () {
                                if (IsChangingStation == false) {
                                    if (document.querySelector('.loading-screen').style.display != 'none') {


                                        document.querySelector('.loading-screen').style.display = 'none';
                                        console.log('Failed to fetch album covers token. Hiding loading screen!');
                                    }
                                }
                            }, 2000); // 1000 milliseconds = 1 second
                        }
                    }, 1000); // 1000 milliseconds = 1 second
                }
                showNotification('Failed to fetch Album Covers token. Please try again later.');
                throw new Error('Failed to fetch access token: ' + data.error_description);
            }
        }




        let albumCovers = {};

        async function fetchAlbumCovers() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/kubadoPL/Gaming-Radio/main/WebAPP/albumCovers.json');
                albumCovers = await response.json();
                console.log('Album covers fetched successfully:', albumCovers);
            } catch (error) {
                console.error('Error fetching album covers:', error);
            }
        }

        fetchAlbumCovers()

        async function fetchSpotifyCover(query) {
            const fallbackCover = 'https://radio-gaming.stream/Images/Logos/Radio%20Gaming%20Logo%20with%20miodzix%20planet.png';

            try {
                const accessToken = await getSpotifyAccessToken();

                const url = `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&include_external=audio`;

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                const data = await response.json();
                if (data.tracks && data.tracks.items.length > 0) {
                    const track = data.tracks.items[0];



                    // Default cover URL if query does not match any of the predefined ones
                    const defaultCover = track.album.images[0].url;

                    // Get the album cover URL based on the query or use the default cover
                    const albumCover = albumCovers[query] || defaultCover;

                    // Set the album cover src
                    document.getElementById('albumCover').src = albumCover;



                    // Update media session metadata
                    updateMediaSessionMetadata(query, albumCover);
                } else {
                    console.log('No cover found for: ' + query);
                    document.getElementById('albumCover').src = fallbackCover;

                    // Update media session metadata with fallback cover
                    updateMediaSessionMetadata(query, fallbackCover);
                }
            } catch (error) {
                console.error('Error fetching Spotify cover:', error);
                document.getElementById('albumCover').src = fallbackCover;

                // Update media session metadata with fallback cover
                updateMediaSessionMetadata(query, fallbackCover);
            }
        }

        function updateMediaSessionMetadata(title, artwork) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: title,
                    artist: stationName.textContent, // Use the station name or any other appropriate artist info
                    album: 'Radio Gaming Stream',
                    artwork: [
                        { src: artwork, sizes: '512x512', type: 'image/png' }
                    ]
                });

                // Handle play/pause actions
                navigator.mediaSession.setActionHandler('play', function () {
                    audio.load();
                    audio.play();
                    playPauseIcon.className = 'fas fa-pause';
                });

                navigator.mediaSession.setActionHandler('pause', function () {
                    audio.pause();
                    playPauseIcon.className = 'fas fa-play';
                });

                // Handle stop action (when "X" button is pressed)
                navigator.mediaSession.setActionHandler('stop', function () {
                    audio.pause(); // Stop the audio
                    playPauseIcon.className = 'fas fa-play'; // Update the icon to the play icon
                });

            }
        }

        function showNotification(message) {
            const container = document.getElementById('notificationContainer');
            if (!container) {
                console.error("Element with id 'notificationContainer' not found!");
                return;
            }

            const notification = document.createElement('div');
            notification.className = 'notificationPopup';

            // Create inner structure with icon
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas fa-bell"></i>
                </div>
                <div class="notification-message">${message}</div>
            `;

            // Apply dynamic border color if it changes
            notification.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--active-station-color');

            container.appendChild(notification);

            // Remove after animation ends
            setTimeout(() => {
                notification.remove();
            }, 5600);
        }

        showNotification("Welcome to Radio GAMING!");

        function playPause() {
            if (audio.paused) {
                audio.load();
                audio.play();
                playPauseIcon.className = 'fas fa-pause';
                showNotification("Now Playing!");
            } else {
                audio.pause();
                playPauseIcon.className = 'fas fa-play';
                showNotification("Paused!");
            }
        }

        let previousVolume = 1;

        function changeVolume(value) {
            audio.volume = value;
            previousVolume = value;
        }

        // Mute volume when clicking the volume-down icon
        document.getElementById('volume-down').addEventListener('click', function () {
            previousVolume = audio.volume;
            audio.volume = 0;
            document.querySelector('.volume-slider').value = 0;
            showNotification("Muting volume!");
        });

        // Restore volume when clicking the volume-up icon
        document.getElementById('volume-up').addEventListener('click', function () {
            audio.volume = previousVolume;
            document.querySelector('.volume-slider').value = previousVolume;
            showNotification("Restoring volume!");
        });

        function changeStation(source, name, metadataURL) {
            if (cooldown == true) {
                console.log('Cooldown active. Please wait before changing the station again.');
                return; // Prevent changing the station if cooldown is active
            }
            IsChangingStation = true; // Set flag to prevent multiple station changes
            var audio = document.getElementById('audioPlayer');
            var stationName = document.querySelector('h1');
            var streamTitleElement = document.getElementById('streamTitle');
            var playPauseIcon = document.getElementById('playPauseIcon');
            var liveIndicator = document.getElementById('liveIndicator');

            var stationDetails = {
                "https://stream.zeno.fm/es4ngpu7ud6tv": {
                    backgroundImage: "url('https://radio-gaming.stream/Images/Radio-Gaming-Background.webp')",
                    playerControlsBackgroundColor: "#420092",
                    borderColor: "#7300ff",
                    secondaryColor: "#a855f7",
                    glowColor: "rgba(115, 0, 255, 0.6)",
                    loadingBackgroundColor: "#7300ff",
                    liveEmoji: "ðŸŸ£LIVE",
                    streamTitleColor: "#ffffff"
                },
                "https://stream.zeno.fm/pfg9eajshnjtv": {
                    backgroundImage: "url('https://radio-gaming.stream/Images/Radio-Gaming-Dark-background.webp')",
                    playerControlsBackgroundColor: "#293cca",
                    borderColor: "#293cca",
                    secondaryColor: "#3e5aff",
                    glowColor: "rgba(41, 60, 202, 0.6)",
                    loadingBackgroundColor: "#293cca",
                    liveEmoji: "ðŸ”µLIVE",
                    streamTitleColor: "#0039ff"
                },
                "https://stream.zeno.fm/5nhy0myl4jpuv": {
                    backgroundImage: "url('https://radio-gaming.stream/Images/Radio-Gaming-Maron-FM-background-Polished.webp')",
                    playerControlsBackgroundColor: "#272956",
                    borderColor: "#272956",
                    secondaryColor: "#4a4e8a",
                    glowColor: "rgba(39, 41, 86, 0.6)",
                    loadingBackgroundColor: "#272956",
                    liveEmoji: "ðŸŸ£LIVE",
                    streamTitleColor: "#272956"
                }
            };

            // Update CSS Variables for the active station color
            document.documentElement.style.setProperty('--active-station-color', stationDetails[source].borderColor);
            document.documentElement.style.setProperty('--active-station-color-secondary', stationDetails[source].secondaryColor);
            document.documentElement.style.setProperty('--active-station-glow', stationDetails[source].glowColor);

            // Show loading screen
            var loadingBackgroundColor = stationDetails[source].loadingBackgroundColor;
            document.querySelector('.loading-screen').style.backgroundColor = loadingBackgroundColor;
            document.querySelector('.loading-screen').style.display = 'flex';

            // Update notification color
            //document.getElementById('notificationPopup').style.backgroundColor = loadingBackgroundColor;
            globalCurrentColor = loadingBackgroundColor;

            // Update CSS properties based on the selected station
            var backgroundImage = stationDetails[source].backgroundImage;
            document.body.style.backgroundImage = backgroundImage;
            document.querySelectorAll('.station-photo').forEach(function (photo) {
                if (photo.getAttribute('onclick').includes(source)) {
                    photo.classList.add('active');
                } else {
                    photo.classList.remove('active');
                }
            });

            document.querySelectorAll('.station-photo.active').forEach(function (photo) {
                photo.style.borderColor = stationDetails[source].borderColor;
            });

            // Update live indicator emoji
            liveIndicator.textContent = stationDetails[source].liveEmoji;

            // Change stream title color
            streamTitleElement.style.color = stationDetails[source].streamTitleColor;

            // Change scrollbar thumb color
            document.documentElement.style.setProperty('--scrollbar-thumb-color', stationDetails[source].loadingBackgroundColor);

            // Change station details
            audio.src = source;
            audio.load();
            audio.play();
            playPauseIcon.className = 'fas fa-pause';
            stationName.textContent = name;
            showNotification("Changing station to: " + name);

            // Update event source URL
            if (currentEventSource) {
                currentEventSource.close();
            }
            var eventSource = new EventSource(metadataURL);
            currentEventSource = eventSource;

            eventSource.onmessage = function (event) {
                try {
                    var jsonData = JSON.parse(event.data);
                    if (jsonData.streamTitle) {
                        var cleanedTitle = cleanTitle(jsonData.streamTitle);
                        streamTitleElement.textContent = 'LIVE STREAM: ' + cleanedTitle;
                        fetchSpotifyCover(cleanedTitle); // Fetch and display the Spotify cover
                    }
                } catch (error) {
                    console.error('Error processing data:', error);
                }
            };

            // Wait for the background image to load
            cooldown = true; // Set cooldown to true to prevent changing the station again immediately
            var backgroundImg = new Image();
            backgroundImg.src = backgroundImage.slice(5, -2); // Remove 'url(' and ')' from the backgroundImage string
            backgroundImg.onload = function () {
                setTimeout(function () {
                    if (fetching == true) {
                        console.log('Already fetching a new Spotify access token. Please wait...');
                        return; // Prevent hiding the loading screen if fetching is in progress
                    }
                    if (document.querySelector('.loading-screen').style.display != 'none') {


                        document.querySelector('.loading-screen').style.display = 'none';
                        console.log('Background image loaded successfully. hiding loading screen!');
                    }
                    cooldown = false
                    IsChangingStation = false; // Reset the flag after changing the station
                }, 3000); // 1000 milliseconds = 1 second
            };
        }

        eventSource.onmessage = function (event) {
            try {
                var jsonData = JSON.parse(event.data);
                if (jsonData.streamTitle) {
                    var cleanedTitle = cleanTitle(jsonData.streamTitle);
                    streamTitleElement.textContent = 'LIVE STREAM: ' + cleanedTitle;
                    fetchSpotifyCover(cleanedTitle); // Fetch and display the Spotify cover
                }
            } catch (error) {
                console.error('Error processing data:', error);
            }
        };

        eventSource.onerror = function (error) {
            console.error('Connection error:', error);
            eventSource.close();
        };

        window.onbeforeunload = function () {
            eventSource.close();
        };

        var currentTimeElement = document.getElementById('currentTime');
        audio.addEventListener('timeupdate', function () {
            var currentTime = formatTime(audio.currentTime);
            currentTimeElement.textContent = currentTime;
        });

        function formatTime(time) {
            var hours = Math.floor(time / 3600);
            var minutes = Math.floor((time % 3600) / 60);
            var seconds = Math.floor(time % 60);

            var formattedTime = '';

            if (hours > 0) {
                formattedTime += (hours < 10 ? '0' + hours : hours) + ':';
            }

            formattedTime += (minutes < 10 ? '0' + minutes : minutes) + ':' +
                (seconds < 10 ? '0' + seconds : seconds);

            return formattedTime;
        }

        function cleanTitle(title) {
            title = title.replace(/\.mp3/gi, '')
                .replace(/\(official music video\)/gi, '')
                .replace(/\[SPOTIFY-DOWNLOADER.COM\]/gi, '')
                .replace(/\[HD\]/gi, '')
                .replace(/\[NEW SONG\]/gi, '')
                .replace(/\(gotg3 song adam warlock intro\)/gi, '')
                .replace(/\(Official song\)/gi, '')
                .replace(/\(with Lyrics\)/gi, '')
                .replace(/\(w?\)/gi, '')
                .replace(/Lyrics/gi, '')
                .replace(/\(Lyric Video\)/gi, '')
                .replace(/\(Official Audio\)/gi, '')
                .replace(/\(Official Video\)/gi, '')
                .replace(/\((1)\)/gi, '')
                .replace(/\(Official\)/gi, '')
                .replace(/\[Official Music Video\]/gi, '')
                .replace(/\?+/g, '');

            return title.trim();
        }

        // Initial loading screen logic
        window.onload = function () {
            var backgroundImg = new Image();
            backgroundImg.src = getComputedStyle(document.body).backgroundImage.slice(5, -2); // Remove 'url(' and ')' from the backgroundImage string
            backgroundImg.onload = function () {
                setTimeout(function () {
                    if (fetching == true) {
                        console.log('Already fetching a new Spotify access token. Please wait...');
                        return; // Prevent hiding the loading screen if fetching is in progress
                    }
                    if (document.querySelector('.loading-screen').style.display != 'none') {


                        document.querySelector('.loading-screen').style.display = 'none';
                        console.log('Background image loaded successfully. hiding loading screen!');
                    }
                }, 1000); // 1000 milliseconds = 1 second
            };
        };


        async function metaDataUrlToStationName(metadataUrl) {
            let stationName = null;
            if (metadataUrl == 'https://api.zeno.fm/mounts/metadata/subscribe/es4ngpu7ud6tv') {
                stationName = 'Radio GAMING';
            } else if (metadataUrl == 'https://api.zeno.fm/mounts/metadata/subscribe/pfg9eajshnjtv') {
                stationName = 'Radio GAMING DARK';
            } else if (metadataUrl == 'https://api.zeno.fm/mounts/metadata/subscribe/5nhy0myl4jpuv') {
                stationName = 'Radio GAMING MARON FM';
            }
            else {
                stationName = 'Unknown Station';
            }
            console.log("Station name for metadata URL", metadataUrl, "is", stationName);
            return stationName;
        }
        // Function to fetch Spotify album cover and update tooltip
        async function fetchSpotifyCovertooltip(query, tooltipElement) {
            const fallbackCover = 'https://radio-gaming.stream/Images/Logos/Radio%20Gaming%20Logo%20with%20miodzix%20planet.png';

            if (!query) {
                tooltipElement.querySelector('.tooltip-cover').src = fallbackCover;
                tooltipElement.querySelector('.tooltip-track').textContent = 'Track not found';
                return;
            }

            try {
                const accessToken = await getSpotifyAccessToken();
                const url = `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&include_external=audio`;

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                const data = await response.json();

                if (data.tracks && data.tracks.items.length > 0) {
                    const track = data.tracks.items[0];


                    const defaultCover = track.album.images[0].url; // default cover image URL

                    const albumCover = albumCovers[query] || defaultCover;
                    tooltipElement.querySelector('.tooltip-cover').src = albumCover;





                } else {
                    tooltipElement.querySelector('.tooltip-cover').src = fallbackCover;
                    tooltipElement.querySelector('.tooltip-track').textContent = 'Track not found';
                }
            } catch (error) {
                console.error('Error fetching Spotify cover:', error);
                tooltipElement.querySelector('.tooltip-cover').src = fallbackCover;
                tooltipElement.querySelector('.tooltip-track').textContent = 'Error loading track';
            }
        }

        // Function to handle EventSource and update tooltip
        function handleEventSource(metadataUrl, tooltipElement) {
            const eventSource = new EventSource(metadataUrl);

            eventSource.onmessage = async function (event) {
                try {
                    const jsonData = JSON.parse(event.data);
                    if (jsonData.streamTitle) {
                        const cleanedTitle = cleanTitle(jsonData.streamTitle);

                        // Update the tooltip with stream title
                        tooltipElement.querySelector('.tooltip-track').textContent = 'LIVE STREAM: ' + cleanedTitle;

                        // Fetch Spotify cover and update tooltip
                        await fetchSpotifyCovertooltip(cleanedTitle, tooltipElement);
                    }
                } catch (error) {
                    console.error('Error processing data:', error);
                }
            };

            eventSource.onerror = function (error) {
                console.error('Connection error:', error);
                eventSource.close();
            };

            return eventSource;
        }

        // Manage EventSource instances
        const eventSources = new Map();

        // Event listener setup for station photos
        document.querySelectorAll('.station-photo').forEach(station => {
            station.addEventListener('mouseover', function () {
                const tooltip = this.querySelector('.tooltip');
                const metadataUrl = this.getAttribute('onclick').split(", ")[2].replace(/[')]/g, '').trim();

                if (metadataUrl) {
                    if (eventSources.has(metadataUrl)) {
                        // Close existing EventSource if it exists
                        eventSources.get(metadataUrl).close();
                    }

                    // Open a new EventSource for the station
                    const newEventSource = handleEventSource(metadataUrl, tooltip);
                    eventSources.set(metadataUrl, newEventSource);
                }
            });
        });

        // Clean up event sources when mouse leaves the station
        document.querySelectorAll('.station-photo').forEach(station => {
            station.addEventListener('mouseleave', function () {
                const metadataUrl = this.getAttribute('onclick').split(", ")[2].replace(/[')]/g, '').trim();

                if (metadataUrl && eventSources.has(metadataUrl)) {
                    // Close the EventSource when the mouse leaves the station
                    eventSources.get(metadataUrl).close();
                    eventSources.delete(metadataUrl);
                }
            });
        });
        async function updateOnlineUsersTooltip(tooltipElement, stationName, metadataUrl) {
            try {
                let stationNameWithoutChanges = stationName;
                stationName = stationName.replace(/\s+/g, '').toUpperCase(); // Normalize station name
                const cacheKey = `listenerCount_${stationName}`;
                const now = Date.now();

                // Try to get cached data from localStorage
                const cachedStr = localStorage.getItem(cacheKey);
                if (cachedStr) {
                    const cached = JSON.parse(cachedStr);
                    // Check if cache is less than 5 minutes old
                    if (now - cached.timestamp < 5 * 60 * 1000) {
                        const elapsed = now - cached.timestamp; // ms elapsed since cache
                        const refreshInterval = 5 * 60 * 1000; // 5 minutes in ms
                        const timeLeftMs = refreshInterval - elapsed;

                        // Convert to minutes and seconds
                        const minutesLeft = Math.floor(timeLeftMs / 60000);
                        const secondsLeft = Math.ceil((timeLeftMs % 60000) / 1000);

                        const timeLeftFormatted = `${minutesLeft}m ${secondsLeft}s`;

                        updateTooltip(tooltipElement, `${cached.listenerCount}`, stationNameWithoutChanges);
                        console.log(`Used cached listener count for ${stationName}, refresh in ${timeLeftFormatted}`);
                        return;
                    }

                }

                console.log("Fetching fresh listener count for " + stationName);
                const response = await fetch('https://bot-launcher-discord-017f7d5f49d9.herokuapp.com/ZenoFMApi/get-sum?station=' + stationName);
                const data = await response.json();
                const listenerCount = data.total_sum;

                // Cache new data in localStorage
                localStorage.setItem(cacheKey, JSON.stringify({
                    listenerCount,
                    timestamp: now
                }));

                updateTooltip(tooltipElement, listenerCount, stationNameWithoutChanges);

            } catch (error) {
                console.error("Failed to fetch listener count:", error);
                updateTooltip(tooltipElement, null, stationNameWithoutChanges, true);
            }
        }

        function updateTooltip(tooltipElement, listenerCount, stationNameWithoutChanges, isError = false) {
            if (!tooltipElement) {
                console.warn("Tooltip element not found!");
                return;
            }
            const tooltipElement2 = tooltipElement.querySelector('.tooltip-Online-Users');
            if (!tooltipElement2) {
                console.warn("tooltip-Online-Users element not found!");
                return;
            }
            if (isError) {
                tooltipElement2.textContent = 'Error loading Live Listeners';
                showNotification(`Error loading Live Listeners for ${stationNameWithoutChanges}`);
            } else {
                tooltipElement2.textContent = `Live Listeners: ${listenerCount}`;
            }
            if (listenerCount > 0) {
                tooltipElement2.style.color = '#00ff00'; // Green for positive count
                //wait 1 second before showing the notification
                setTimeout(() => {
                    showNotification(`Live Listeners for ${stationNameWithoutChanges}: ${listenerCount}`);
                }, 1000);

            } else {
                tooltipElement2.style.color = '#ff0000'; // Red for zero or negative count
            }
        }


        function updateAllOnlineUsers() {
            document.querySelectorAll('.station-photo').forEach(station => {
                const tooltip = station.querySelector('.tooltip');

                const metadataUrl = station.getAttribute('onclick').split(", ")[2].replace(/[')]/g, '').trim();
                console.log(metadataUrl)



                let stationName = metaDataUrlToStationName(metadataUrl);
                console.log("Station name for metadata URL", metadataUrl, "is", stationName);
                stationName.then(name => {
                    updateOnlineUsersTooltip(tooltip, name, metadataUrl);
                }).catch(error => {
                    console.error("Error getting station name:", error);
                });
            });
        }

        // Run immediately on page load

        setTimeout(function () {
            console.log("Updating all online users 6 sec after page load");
            // Then update every 1 minute (60000 ms)
            updateAllOnlineUsers();
            setInterval(updateAllOnlineUsers, 60000);
        }, 6000); // 1000 milliseconds = 1 second

        changeVolume(0.1)
    </script>


    <div class="animation-wrapper">
        <div class="particle particle-1"></div>
        <div class="particle particle-2"></div>
        <div class="particle particle-3"></div>
        <div class="particle particle-4"></div>
    </div>
    <footer>
        <div class="footer-content">
            <div class="footer-left">
                &copy; 2025 K5 Studio - All Rights Reserved.
            </div>
            <div class="footer-center">
                <div class="social-links">
                    <a href="https://discord.gg/yourlink" target="_blank" title="Discord"><i
                            class="fab fa-discord"></i></a>
                    <a href="https://twitter.com/yourlink" target="_blank" title="Twitter"><i
                            class="fab fa-twitter"></i></a>
                    <a href="https://youtube.com/yourlink" target="_blank" title="YouTube"><i
                            class="fab fa-youtube"></i></a>
                    <a href="https://instagram.com/yourlink" target="_blank" title="Instagram"><i
                            class="fab fa-instagram"></i></a>
                </div>
            </div>
            <div class="footer-right">
                Developed with <i class="fas fa-heart" style="color: #ff4d4d; animation: heartBeat 1.5s infinite;"></i>
                by K5
            </div>
        </div>
    </footer>

</body>

</html>o